<head>
  <script>

      let setsize = false;
      let dropwidth = 0;
      let dropheight = 0;
      let opened = false;

      const outsideclickhandler = (ev) => {
        const path = ev.composedPath();
        const clickedInside =
          path.some((n) => n && n.id === 'zappbutton') ||
          path.some((n) => n && n.id === 'zappdropdown');
        if (!clickedInside) {
          opened = false;
          const dropdown = document.getElementById("zappdropdown");
          dropdown.style.visibility = opened ? "visible" : "hidden";
          dropdown.contentWindow.postMessage({type: "outsideclick"}, "*")
          document.getElementById("zappbutton").contentWindow.postMessage({type: "outsideclick"}, "*")
          dropdown.contentWindow.postMessage({type: "outsideclick"}, "*")
        }
      };
      window.addEventListener("click", outsideclickhandler);
      const GAP = 4;

      function position(){
        var dropdownroot = document.getElementById("zappdropdown")
        const vrect = document.getElementById("zappbutton").getBoundingClientRect();

        const vw = window.innerWidth;
        const vh = window.innerHeight;

        let left = vrect.x;
        let topBelow = vrect.y + vrect.height + GAP;
        let top = topBelow;

        // Horizontal clamp
        if(left + dropwidth > vw - GAP) left = Math.max(GAP, vw - dropwidth - GAP);
        if(left < GAP) left = GAP;

        // Prefer below, fallback above if overflow
        if(top + dropheight > vh - GAP){
          const topAbove = vrect.y - dropheight - GAP;
          if(topAbove >= GAP){
            top = topAbove;
          }else{
            // Clamp inside viewport
            top = Math.max(GAP, Math.min(top, vh - dropheight - GAP));
          }
        }

        // dropdownroot.style.left = left + "px";
        dropdownroot.style.transform = `translatex(${left}px)`
        dropdownroot.style.top = top + "px";
      }

      function openAnimation(){
        const root = document.getElementById("zappdropdown")
        // Avoid duplicating listeners
        if(!root._repositionBound){
          const handler = () => position();
          window.addEventListener("resize", handler);
          window.addEventListener("scroll", handler, true);
          root._repositionBound = true;
        }
        position();
      }

      window.onmessage = function(e){
        const button = document.getElementById("zappbutton");
        const dropdown = document.getElementById("zappdropdown");
        try{
          let msg = JSON.parse(e.data);
          if(msg.type === "buttonclick"){
            opened = !opened;
            dropdown.style.visibility = opened ? "visible" : "hidden";
            dropdown.contentWindow.postMessage({type: 'state', state: opened}, "*")
            if(opened) openAnimation();
          }else if(msg.type === "dropdown-box" && !setsize){
            setsize = true;
            dropwidth = msg.box.width;
            dropheight = msg.box.height;
            dropdown.style.width = `${dropwidth}px`;
            dropdown.style.height = `${dropheight + 7}px`;
          }else if(msg.type === "state"){
            opened = msg.state;
            dropdown.style.visibility = opened ? "visible" : "hidden";
            button.contentWindow.postMessage(msg, "*")
          }
          else{
            console.error("no supported msg type: " + msg.type)
          }
        }catch(err){
          console.error(err);
        }
      }
    </script>
</head>

<div id="navbar">
  <div class="navbar <%= 'is-transparent' if defined? @transparent_nav %>">
    <div class="navbar-brand">
      <a class="navbar-item" id="logo-link" href="/">
        <% if christmastime? %>
          <img id="santa" src="/assets/images/pusheen.png">
        <% end %>
        <!-- <img id="logo" src="<%= zeus_logo_url color: @zeus_logo_color %>" alt=""> -->
        <%= render '/partials/_zeus_logo.erb' %>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
    <div class="navbar-menu">
      <div class="navbar-start">
        <% navigables.each do |i| %>
        <a class="navbar-item <%= 'is-active' if child_of(i) %>" href="<%= i.path %>">
          <%= i[:title] %>
        </a>
        <% end %>

        <!-- Mirror button in navbar -->
        <script>
          function switchMirroredInCookie() {
            if (!document.cookie.includes("mirrored=true")) {
              document.cookie = "mirrored=true;path=/";
              document.body.classList.remove("unmirror");
              document.body.classList.add("mirror");
            } else {
              document.cookie = "mirrored=false;path=/";
              document.body.classList.remove("mirror");
              document.body.classList.add("unmirror");
            }
          }
        </script>
        <a class="navbar-item" id="mirror" onclick="switchMirroredInCookie()" >
          Mirror
        </a>
        <!-- Mirror -->

        <% if new_member_time? %>
          <a class="navbar-item" id="ledenformulier" href="https://zeus.gent/ledenformulier">
            Schrijf je in!
          </a>
        <%end%>

        
      </div>
      <!-- TODO: Remove this is-hidden-touch, it's just a convenience for now -->
      <div class="navbar-end is-hidden-touch">
        <form action="/search/?" method="get" class="navbar-item nav-search">
          <div id="tipue_search_input">
            <input type="text" name="q" id="tipue_search_input_field" autocomplete="off">
          </div>
        </form>
        <a class="navbar-item social-icon" href="https://github.com/ZeusWPI" target="_blank">
          <span class="icon">
            <%= fa :github %>
          </span>
        </a>
        <a class="navbar-item social-icon" href="https://www.facebook.com/zeus.wpi/" target="_blank">
          <span class="icon">
            <%= fa :facebook %>
          </span>
        </a>
        <a class="navbar-item social-icon" href="/feed.xml" target="_blank">
          <span class="icon">
            <%= fa :rss %>
          </span>
        </a>
        <a class="navbar-item social-icon" href="/ical.ics">
          <span class="icon">
            <%= fa :calendar %>
          </span>
        </a>
      </div>
      <iframe sandbox="allow-scripts"
        id="zappbutton"
        src="https://zapp.zeus.gent/zapp-iframe/button.html"
        style="height: 3.7em; aspect-ratio: 1 / 1; border: none; overflow: hidden; scrollbar-width: 0;"
      >
      </iframe>

      
    </div>
  </div>
</div>
